pipeline:
    build:
        image: itapteka/fake
        pull: true
        volumes:
            - /home/dsemenov87/nuget/:/root/.nuget/packages
        environment:
            - PG_HOST="db"
            - REDIS_HOST="cache"
        commands:
            - dotnet /usr/local/bin/fake/fake.dll -v run build.fsx

    publish-feature:
        image: plugins/docker
        repo: itapteka/tax-calculator
        tags: [ $DRONE_BRANCH ]
        # volumes:
        #     - /var/run/docker.sock:/var/run/docker.sock
        when:
            branch: feature/*

    deploy-feature-kube:
        image: vallard/drone-kube
        template: ./k8s/deployment.yaml
        namespace: $DRONE_BRANCH
        server: https://95.163.251.232:6443
        when:
            branch: feature/*

services:
  db:
    image: postgres:alpine

  cache:
    image: redis:alpine